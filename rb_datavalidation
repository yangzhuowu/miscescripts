/*     Date: 08/05/2024
    Subject: SQL queries used for the CIO project front-end data validation
    Purpose: Validate the results shown on the Power BI front-end against the results produced by SQL queries in Snowflake.
      Notes: As contents are added or changed on the Power BI front-end regularly, the queries will be modified to reflect those changes.
*/

/* Find Fund Manager Code */
SELECT DISTINCT(FUND_MGR_NAME), FUND_MGR_CODE FROM DEV_RAW_DB.INT_DATASETS.LEAD_IM_CODE_EXTRACT
WHERE FUND_MGR_NAME LIKE 'LON%JAMES%LYNCH'
-- 'LON%DAVID%' 429, 
-- 'LON%JAMES%LYNCH' 431

/*========================================= TEST on Overview Page ============================================= */

/* #1: Value of Individual Security Name */
SELECT SECURITY_NAME, SUM(SUM_TOTAL_VALUE) AS VALUE
FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
WHERE FUND_MANAGER_CODE = 429
GROUP BY SECURITY_NAME
ORDER BY VALUE DESC

/* #2: Total value of All Security Name from #1 */
SELECT SUM(VALUE)
FROM (SELECT SECURITY_NAME, SUM(SUM_TOTAL_VALUE) AS VALUE
        FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
        WHERE FUND_MANAGER_CODE = 429
        GROUP BY SECURITY_NAME
        ORDER BY VALUE DESC)

/* #3: Value for a selected Fund Manager, selected Fund Name group by Security Name */
SELECT SECURITY_NAME, SUM(SUM_TOTAL_VALUE) AS VALUE
FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS 
WHERE FUND_MANAGER_CODE = 429
AND FUND_REF = 37771
GROUP BY SECURITY_NAME
ORDER BY VALUE DESC

/* #4: Total value of All Security Name from #3 */
SELECT SUM(VALUE)
FROM (SELECT SECURITY_NAME, SUM(SUM_TOTAL_VALUE) AS VALUE
        FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS 
        WHERE FUND_MANAGER_CODE = 429
        AND FUND_REF = 37771
        GROUP BY SECURITY_NAME
        ORDER BY VALUE DESC)

/* #5: Cross-check value of Cash from #3 */
SELECT DISTINCT TABLE1.FUND_MANAGER_CODE, TABLE1.FUND_REF, TABLE1.SECURITY_NAME, TABLE1.SUM_TOTAL_VALUE, 
                TABLE2.CASE_REF, TABLE2.CASE_NAME, TABLE2.FUND_NAME, TABLE2.FUND_REF, TABLE2.RISK_LEVEL,
    FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS AS TABLE1, 
         DEV_ANALYTICS_DB.CIO_VISION.CASE_FUND AS TABLE2,
WHERE TABLE1.FUND_REF = TABLE2.FUND_REF
AND TABLE1.FUND_MANAGER_CODE = 429
AND TABLE1.FUND_REF = 37771
AND TABLE1.SECURITY_NAME = 'Cash'

/* #6: Value for a selected Fund Manager, selected Portfolio Name and a Security Name */
SELECT TABLE1.SECURITY_NAME, SUM(TABLE1.SUM_TOTAL_VALUE) AS VALUE
FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS AS TABLE1,
      DEV_RAW_DB.INT_DATASETS.VW_PORTFOLIO_EXTRACT AS TABLE2
WHERE TABLE1.FUND_REF = TABLE2.FUNDREF
AND TABLE1.FUND_MANAGER_CODE = 429
AND TABLE2.PORTFOLIOREF = 'R002561'
GROUP BY TABLE1.SECURITY_NAME
ORDER BY VALUE DESC

/* #7: Total value of All Security Name from #6 */
SELECT SUM(VALUE)
FROM (SELECT TABLE1.SECURITY_NAME, SUM(TABLE1.SUM_TOTAL_VALUE) AS VALUE
        FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS AS TABLE1,
              DEV_RAW_DB.INT_DATASETS.VW_PORTFOLIO_EXTRACT AS TABLE2
        WHERE TABLE1.FUND_REF = TABLE2.FUNDREF
        AND TABLE1.FUND_MANAGER_CODE = 429
        AND TABLE2.PORTFOLIOREF = 'R002561'
        GROUP BY TABLE1.SECURITY_NAME
        ORDER BY VALUE DESC)

/* #8: Cross-check value of Cash from #6 joining four tables (same logic from PowerBI) */
SELECT TABLE1.SECURITY_NAME, SUM(TABLE1.SUM_TOTAL_VALUE) AS VALUE
    FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS  AS TABLE1,
        DEV_ANALYTICS_DB.CIO_VISION.CASE_FUND AS TABLE2,
        DEV_ANALYTICS_DB.CIO_VISION.FUND_DETAILS AS TABLE3,
        DEV_RAW_DB.INT_DATASETS.VW_PORTFOLIO_EXTRACT AS TABLE4
WHERE TABLE1.FUND_REF = TABLE2.FUND_REF
AND TABLE2.FUND_REF = TABLE3.FUND_REF
AND TABLE3.FUND_REF = TABLE4.FUNDREF
AND TABLE1.FUND_MANAGER_CODE = 429
AND TABLE4.PORTFOLIOREF = 'R002561'
--AND TABLE1.FUND_REF = 53775
GROUP BY TABLE1.SECURITY_NAME 
ORDER BY VALUE DESC

/* ================================== TEST on Geography Regional Distribution Page ================================= */

/* #1: Value of Individual Security Name group by Security Name */
SELECT SECURITY_NAME, SEDOL_NO, SUM(SUM_TOTAL_VALUE) AS VALUE
FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
WHERE FUND_MANAGER_CODE = 429
--AND FUND_REF = 53755
GROUP BY SECURITY_NAME, SEDOL_NO
ORDER BY VALUE DESC

/* #2: Total number of Securities for a selected Fund Manager from #1 */
SELECT COUNT(SECURITY_NAME)
FROM
    (SELECT SECURITY_NAME, SEDOL_NO, SUM(SUM_TOTAL_VALUE) AS VALUE
    FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
    WHERE FUND_MANAGER_CODE = 429
    GROUP BY SECURITY_NAME, SEDOL_NO
    ORDER BY VALUE DESC)
    
/* #3: Total Value of All Securities for a selected Fund Manager from #1 */
SELECT SUM(VALUE)
FROM
    (SELECT SECURITY_NAME, SEDOL_NO, SUM(SUM_TOTAL_VALUE) AS VALUE
    FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
    WHERE FUND_MANAGER_CODE = 429
    GROUP BY SECURITY_NAME, SEDOL_NO
    ORDER BY VALUE DESC)
--215860169.21

/* #4: Total Value of All Securities for a selected Fund Manager - ALL SECURITIES or EQUITY ONLY */
SELECT SUM(REGION_FINAL_RES.FINAL_VALUE)
FROM
    (SELECT REGION_TABLE.SEDOL_NO AS SEDOL_NO,
            REGION_TABLE.VENDOR AS VENDOR,
            REGION_TABLE.NET_WEIGHT_DECIMAL AS NET_WEIGHT_DECIMAL,
            SECURITY_TABLE.SECURITY_VALUE AS SECURITY_VALUE,
            SECURITY_TABLE.SECURITY_VALUE * REGION_TABLE.NET_WEIGHT_DECIMAL AS FINAL_VALUE
    FROM DEV_ANALYTICS_DB.CIO_VISION.FULL_UNIVERSE_GEOGRAPHY AS REGION_TABLE,
        (SELECT SECURITY_NAME, 
                SEDOL_NO, 
                SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
            FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
            WHERE FUND_MANAGER_CODE = 429
            GROUP BY SECURITY_NAME, SEDOL_NO
            ORDER BY SECURITY_VALUE DESC) AS SECURITY_TABLE
    WHERE REGION_TABLE.SEDOL_NO = SECURITY_TABLE.SEDOL_NO
    --AND REGION_TABLE.EQUITY_ONLY = 'Yes'
    ) AS REGION_FINAL_RES
--213780907.3868640

/* #5: Total Number of Securities for a selected Fund Manager - ALL SECURITIES or EQUITY ONLY */
SELECT COUNT(SECURITY_NAME)
FROM
    (SELECT TABLE1.SECURITY_NAME AS SECURITY_NAME, 
           SUM(TABLE1.SUM_TOTAL_VALUE) AS VALUE,
    FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS AS TABLE1,
          DEV_ANALYTICS_DB.CIO_VISION.FULL_UNIVERSE_GEOGRAPHY AS TABLE2
    WHERE TABLE1.SEDOL_NO = TABLE2.SEDOL_NO
        AND TABLE1.FUND_MANAGER_CODE = 429
        --AND TABLE2.EQUITY_ONLY = 'Yes'   
    GROUP BY SECURITY_NAME
    ORDER BY VALUE DESC)

/* #6: Regional Value for a selected Fund Manager group by Regional Name - ALL SECURITIES or EQUITY ONLY */  
SELECT REGION_FINAL_RES.REGION_NAME AS REGION_NAME,
       SUM(REGION_FINAL_RES.FINAL_VALUE) AS REGION_VALUE
FROM
    (SELECT REGION_TABLE.SEDOL_NO AS SEDOL_NO,
            REGION_TABLE.VENDOR AS VENDOR,
            REGION_TABLE.NET_WEIGHT_DECIMAL AS NET_WEIGHT_DECIMAL,
            SECURITY_TABLE.SECURITY_VALUE AS SECURITY_VALUE,
            COUNTRY_MAPPING.REGION AS REGION_NAME,
            SECURITY_TABLE.SECURITY_VALUE * REGION_TABLE.NET_WEIGHT_DECIMAL AS FINAL_VALUE
    FROM DEV_ANALYTICS_DB.CIO_VISION.FULL_UNIVERSE_GEOGRAPHY AS REGION_TABLE,
         DEV_ANALYTICS_DB.CIO_VISION.COUNTRY_MAPPING AS COUNTRY_MAPPING,
        (SELECT SECURITY_NAME, 
                SEDOL_NO, 
                SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
            FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
            WHERE FUND_MANAGER_CODE = 429
            GROUP BY SECURITY_NAME, SEDOL_NO
            ORDER BY SECURITY_VALUE DESC) AS SECURITY_TABLE
    WHERE REGION_TABLE.SEDOL_NO = SECURITY_TABLE.SEDOL_NO
    AND REGION_TABLE.ASSET_CLASS_REGION_COMBO_INTERNAL = COUNTRY_MAPPING.COUNTRY
    AND REGION_TABLE.EQUITY_ONLY = 'Yes'
    ) AS REGION_FINAL_RES
GROUP BY REGION_NAME
ORDER BY REGION_VALUE DESC

/* #7: Regional Value for a selected Fund Manager and a selected Fund group by Regional Name - ALL SECURITIES or EQUITY ONLY */  
SELECT REGION_FINAL_RES.REGION_NAME AS REGION_NAME,
       SUM(REGION_FINAL_RES.FINAL_VALUE) AS REGION_VALUE
FROM
    (SELECT REGION_TABLE.SEDOL_NO AS SEDOL_NO,
            REGION_TABLE.VENDOR AS VENDOR,
            REGION_TABLE.NET_WEIGHT_DECIMAL AS NET_WEIGHT_DECIMAL,
            SECURITY_TABLE.SECURITY_VALUE AS SECURITY_VALUE,
            COUNTRY_MAPPING.REGION AS REGION_NAME,
            SECURITY_TABLE.SECURITY_VALUE * REGION_TABLE.NET_WEIGHT_DECIMAL AS FINAL_VALUE
    FROM DEV_ANALYTICS_DB.CIO_VISION.FULL_UNIVERSE_GEOGRAPHY AS REGION_TABLE,
         DEV_ANALYTICS_DB.CIO_VISION.COUNTRY_MAPPING AS COUNTRY_MAPPING,
        (SELECT SECURITY_NAME, 
                SEDOL_NO, 
                SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
            FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
            WHERE FUND_MANAGER_CODE = 429
            AND FUND_REF = 37771
            GROUP BY SECURITY_NAME, SEDOL_NO
            ORDER BY SECURITY_VALUE DESC) AS SECURITY_TABLE
    WHERE REGION_TABLE.SEDOL_NO = SECURITY_TABLE.SEDOL_NO
    AND REGION_TABLE.ASSET_CLASS_REGION_COMBO_INTERNAL = COUNTRY_MAPPING.COUNTRY
    AND REGION_TABLE.EQUITY_ONLY = 'Yes'
    ) AS REGION_FINAL_RES
GROUP BY REGION_NAME
ORDER BY REGION_VALUE DESC

/* #8: Country Value for a selected Fund Manager group by Country Name - ALL SECURITIES or EQUITY ONLY */
SELECT COUNTRY_FINAL_RES.COUNTRY_NAME AS COUNTRY_NAME,
       SUM(COUNTRY_FINAL_RES.FINAL_VALUE) AS COUNTRY_VALUE
FROM
    (SELECT REGION_TABLE.SEDOL_NO AS SEDOL_NO,
            SECURITY_TABLE.SECURITY_NAME AS SECURITY_NAME,
            REGION_TABLE.VENDOR AS VENDOR,
            REGION_TABLE.NET_WEIGHT_DECIMAL AS NET_WEIGHT_DECIMAL,
            SECURITY_TABLE.SECURITY_VALUE AS SECURITY_VALUE,
            COUNTRY_MAPPING.COUNTRY AS COUNTRY_NAME,
            SECURITY_TABLE.SECURITY_VALUE * REGION_TABLE.NET_WEIGHT_DECIMAL AS FINAL_VALUE
    FROM DEV_ANALYTICS_DB.CIO_VISION.FULL_UNIVERSE_GEOGRAPHY AS REGION_TABLE,
         DEV_ANALYTICS_DB.CIO_VISION.COUNTRY_MAPPING AS COUNTRY_MAPPING,
        (SELECT SECURITY_NAME, 
                SEDOL_NO, 
                SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
            FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
            WHERE FUND_MANAGER_CODE = 429
            and sedol_no = 'B5510F7'
            GROUP BY SECURITY_NAME, SEDOL_NO
            ORDER BY SECURITY_VALUE DESC) AS SECURITY_TABLE
    WHERE REGION_TABLE.SEDOL_NO = SECURITY_TABLE.SEDOL_NO
    AND REGION_TABLE.ASSET_CLASS_REGION_COMBO_INTERNAL = COUNTRY_MAPPING.COUNTRY
    AND REGION_TABLE.EQUITY_ONLY = 'Yes')
    AS COUNTRY_FINAL_RES
GROUP BY COUNTRY_NAME
ORDER BY COUNTRY_VALUE DESC

/* #9: Country Value for a selected Fund Manager and a selected Fund group by Country Name  - ALL SECURITIES or EQUITY ONLY*/
SELECT COUNTRY_FINAL_RES.COUNTRY_NAME AS COUNTRY_NAME,
       SUM(COUNTRY_FINAL_RES.FINAL_VALUE) AS COUNTRY_VALUE
FROM
    (SELECT REGION_TABLE.SEDOL_NO AS SEDOL_NO,
            REGION_TABLE.VENDOR AS VENDOR,
            REGION_TABLE.NET_WEIGHT_DECIMAL AS NET_WEIGHT_DECIMAL,
            SECURITY_TABLE.SECURITY_VALUE AS SECURITY_VALUE,
            COUNTRY_MAPPING.COUNTRY AS COUNTRY_NAME,
            SECURITY_TABLE.SECURITY_VALUE * REGION_TABLE.NET_WEIGHT_DECIMAL AS FINAL_VALUE
    FROM DEV_ANALYTICS_DB.CIO_VISION.FULL_UNIVERSE_GEOGRAPHY AS REGION_TABLE,
         DEV_ANALYTICS_DB.CIO_VISION.COUNTRY_MAPPING AS COUNTRY_MAPPING,
        (SELECT SECURITY_NAME, 
                SEDOL_NO, 
                SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
            FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
            WHERE FUND_MANAGER_CODE = 429
            AND FUND_REF = 37771
            GROUP BY SECURITY_NAME, SEDOL_NO
            ORDER BY SECURITY_VALUE DESC) AS SECURITY_TABLE
    WHERE REGION_TABLE.SEDOL_NO = SECURITY_TABLE.SEDOL_NO
    AND REGION_TABLE.ASSET_CLASS_REGION_COMBO_INTERNAL = COUNTRY_MAPPING.COUNTRY
    --AND REGION_TABLE.EQUITY_ONLY = 'Yes'
    ) AS COUNTRY_FINAL_RES
GROUP BY COUNTRY_NAME
ORDER BY COUNTRY_VALUE DESC

/* =================================== TEST on ICB Industry Sector Distribution Page ================================ */

/* #1: Net Value of Individual Security group by Security Name */
SELECT SECURITY_NAME, SEDOL_NO, SUM(SUM_TOTAL_VALUE) AS VALUE
FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
WHERE FUND_MANAGER_CODE = 429
GROUP BY SECURITY_NAME, SEDOL_NO
ORDER BY VALUE DESC

/* #2: Total Count of All Securities for a selected Fund Manager from #1 */
SELECT COUNT(SECURITY_NAME)
FROM
    (SELECT SECURITY_NAME, SEDOL_NO, SUM(SUM_TOTAL_VALUE) AS VALUE
    FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
    WHERE FUND_MANAGER_CODE = 429
    GROUP BY SECURITY_NAME, SEDOL_NO
    ORDER BY VALUE DESC
    )

/* #3: Total Value of All Securities for a selected Fund Managerfrom #1 */
SELECT SUM(VALUE)
FROM
    (SELECT SECURITY_NAME, SEDOL_NO, SUM(SUM_TOTAL_VALUE) AS VALUE
    FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
    WHERE FUND_MANAGER_CODE = 429
    GROUP BY SECURITY_NAME, SEDOL_NO
    ORDER BY VALUE DESC
    )

/* #4: Total Value for a selected Fund Manager - EQUITY ONLY */
SELECT SUM(SECTOR_FINAL_RES.FINAL_VALUE)
FROM
    (SELECT SECTOR_TABLE.SEDOL_NO AS SEDOL_NO,
            SECTOR_TABLE.VENDOR AS VENDOR,
            SECTOR_TABLE.NET_WEIGHT_DECIMAL AS NET_WEIGHT_DECIMAL,
            SECURITY_TABLE.SECURITY_VALUE AS SECURITY_VALUE,
            SECURITY_TABLE.SECURITY_VALUE * SECTOR_TABLE.NET_WEIGHT_DECIMAL AS FINAL_VALUE
    FROM DEV_ANALYTICS_DB.CIO_VISION.FULL_UNIVERSE_SECTOR AS SECTOR_TABLE,
        (SELECT SECURITY_NAME, 
                SEDOL_NO, 
                SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
            FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
            WHERE FUND_MANAGER_CODE = 429
            GROUP BY SECURITY_NAME, SEDOL_NO
            ORDER BY SECURITY_VALUE DESC
        ) AS SECURITY_TABLE
    WHERE SECTOR_TABLE.SEDOL_NO = SECURITY_TABLE.SEDOL_NO
    AND SECTOR_TABLE.EQUITY_ONLY = 'Yes'
    ) AS SECTOR_FINAL_RES

/* #4: Total Number of Securities for a selected Fund Manager - EQUITY ONLY */
SELECT COUNT(DISTINCT SECTOR_FINAL_RES.SEDOL_NO)
FROM
    (SELECT SECTOR_TABLE.SEDOL_NO AS SEDOL_NO,
            SECTOR_TABLE.VENDOR AS VENDOR,
            SECTOR_TABLE.NET_WEIGHT_DECIMAL AS NET_WEIGHT_DECIMAL,
            SECURITY_TABLE.SECURITY_VALUE AS SECURITY_VALUE,
            SECURITY_TABLE.SECURITY_VALUE * SECTOR_TABLE.NET_WEIGHT_DECIMAL AS FINAL_VALUE
    FROM DEV_ANALYTICS_DB.CIO_VISION.FULL_UNIVERSE_SECTOR AS SECTOR_TABLE,
        (SELECT SECURITY_NAME, 
                SEDOL_NO, 
                SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
            FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
            WHERE FUND_MANAGER_CODE = 429
            GROUP BY SECURITY_NAME, SEDOL_NO
            ORDER BY SECURITY_VALUE DESC
        ) AS SECURITY_TABLE
    WHERE SECTOR_TABLE.SEDOL_NO = SECURITY_TABLE.SEDOL_NO
    AND SECTOR_TABLE.EQUITY_ONLY = 'Yes'
    ) AS SECTOR_FINAL_RES

/* #5: Industry Value for a selected Fund Manager group by Industry - EQUITY ONLY*/
SELECT INDUSTRY_FINAL_RES.ICB_INDUSTRY AS ICB_INDUSTRY,
       SUM(INDUSTRY_FINAL_RES.FINAL_VALUE) AS INDUSTRY_VALUE
FROM
    (SELECT SECTOR_TABLE.SEDOL_NO AS SEDOL_NO,
            SECTOR_TABLE.VENDOR AS VENDOR,
            SECTOR_TABLE.NET_WEIGHT_DECIMAL AS NET_WEIGHT_DECIMAL,
            SECURITY_TABLE.SECURITY_VALUE AS SECURITY_VALUE,
            SECTOR_MAPPING.ICB_INDUSTRY AS ICB_INDUSTRY,
            SECURITY_TABLE.SECURITY_VALUE * SECTOR_TABLE.NET_WEIGHT_DECIMAL AS FINAL_VALUE
    FROM DEV_ANALYTICS_DB.CIO_VISION.FULL_UNIVERSE_SECTOR AS SECTOR_TABLE,
         DEV_ANALYTICS_DB.CIO_VISION.SECTOR_MAPPING AS SECTOR_MAPPING,
        (SELECT SECURITY_NAME, 
                SEDOL_NO, 
                SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
            FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
            WHERE FUND_MANAGER_CODE = 429
            GROUP BY SECURITY_NAME, SEDOL_NO
            ORDER BY SECURITY_VALUE DESC
        ) AS SECURITY_TABLE
    WHERE SECTOR_TABLE.SEDOL_NO = SECURITY_TABLE.SEDOL_NO
    AND SECTOR_TABLE.ASSET_CLASS_SUBSECTOR_COMBO_INTERNAL = SECTOR_MAPPING.ICB_SUB_SECTOR
    AND SECTOR_TABLE.EQUITY_ONLY = 'Yes'
    ) AS INDUSTRY_FINAL_RES
GROUP BY ICB_INDUSTRY
ORDER BY INDUSTRY_VALUE DESC

/* #6: Sector Value for a selected Fund Manager group by Sector - EQUITY ONLY */
SELECT SECTOR_FINAL_RES.ICB_SECTOR AS ICB_SECTOR,
       SUM(SECTOR_FINAL_RES.FINAL_VALUE) AS SECTOR_VALUE
FROM
    (SELECT SECTOR_TABLE.SEDOL_NO AS SEDOL_NO,
            SECTOR_TABLE.VENDOR AS VENDOR,
            SECTOR_TABLE.NET_WEIGHT_DECIMAL AS NET_WEIGHT_DECIMAL,
            SECURITY_TABLE.SECURITY_VALUE AS SECURITY_VALUE,
            SECTOR_MAPPING.ICB_SECTOR AS ICB_SECTOR,
            SECURITY_TABLE.SECURITY_VALUE * SECTOR_TABLE.NET_WEIGHT_DECIMAL AS FINAL_VALUE
    FROM DEV_ANALYTICS_DB.CIO_VISION.FULL_UNIVERSE_SECTOR AS SECTOR_TABLE,
         DEV_ANALYTICS_DB.CIO_VISION.SECTOR_MAPPING AS SECTOR_MAPPING,
        (SELECT SECURITY_NAME, 
                SEDOL_NO, 
                SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
            FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
            WHERE FUND_MANAGER_CODE = 429
            GROUP BY SECURITY_NAME, SEDOL_NO
            ORDER BY SECURITY_VALUE DESC
        ) AS SECURITY_TABLE
    WHERE SECTOR_TABLE.SEDOL_NO = SECURITY_TABLE.SEDOL_NO
    AND SECTOR_TABLE.ASSET_CLASS_SUBSECTOR_COMBO_INTERNAL = SECTOR_MAPPING.ICB_SUB_SECTOR
    AND SECTOR_TABLE.EQUITY_ONLY = 'Yes'
    ) AS SECTOR_FINAL_RES
GROUP BY ICB_SECTOR
ORDER BY SECTOR_VALUE DESC

/* #7: Total Value for a selected Fund Manager and a selected Fund - ALL SECURITIES or EQUITY ONLY */
SELECT SUM(SECTOR_FINAL_RES.FINAL_VALUE)
FROM
    (SELECT SECTOR_TABLE.SEDOL_NO AS SEDOL_NO,
            SECTOR_TABLE.VENDOR AS VENDOR,
            SECTOR_TABLE.NET_WEIGHT_DECIMAL AS NET_WEIGHT_DECIMAL,
            SECURITY_TABLE.SECURITY_VALUE AS SECURITY_VALUE,
            SECTOR_MAPPING.ICB_SECTOR AS ICB_SECTOR,
            SECURITY_TABLE.SECURITY_VALUE * SECTOR_TABLE.NET_WEIGHT_DECIMAL AS FINAL_VALUE
    FROM DEV_ANALYTICS_DB.CIO_VISION.FULL_UNIVERSE_SECTOR AS SECTOR_TABLE,
         DEV_ANALYTICS_DB.CIO_VISION.SECTOR_MAPPING AS SECTOR_MAPPING,
        (SELECT SECURITY_NAME, 
                SEDOL_NO, 
                SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
            FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
            WHERE FUND_MANAGER_CODE = 429
            AND FUND_REF = 37771
            GROUP BY SECURITY_NAME, SEDOL_NO
            ORDER BY SECURITY_VALUE DESC
        ) AS SECURITY_TABLE
    WHERE SECTOR_TABLE.SEDOL_NO = SECURITY_TABLE.SEDOL_NO
    AND SECTOR_TABLE.ASSET_CLASS_SUBSECTOR_COMBO_INTERNAL = SECTOR_MAPPING.ICB_SUB_SECTOR
    AND SECTOR_TABLE.EQUITY_ONLY = 'Yes'
    ) AS SECTOR_FINAL_RES

/* #8: Total Count for a selected Fund Manager and a selected Fund - ALL SECURITIES or EQUITY ONLY */
SELECT COUNT(DISTINCT SECTOR_FINAL_RES.SEDOL_NO)
FROM
    (SELECT SECTOR_TABLE.SEDOL_NO AS SEDOL_NO,
            SECTOR_TABLE.VENDOR AS VENDOR,
            SECTOR_TABLE.NET_WEIGHT_DECIMAL AS NET_WEIGHT_DECIMAL,
            SECURITY_TABLE.SECURITY_VALUE AS SECURITY_VALUE,
            SECTOR_MAPPING.ICB_SECTOR AS ICB_SECTOR,
            SECURITY_TABLE.SECURITY_VALUE * SECTOR_TABLE.NET_WEIGHT_DECIMAL AS FINAL_VALUE
    FROM DEV_ANALYTICS_DB.CIO_VISION.FULL_UNIVERSE_SECTOR AS SECTOR_TABLE,
         DEV_ANALYTICS_DB.CIO_VISION.SECTOR_MAPPING AS SECTOR_MAPPING,
        (SELECT SECURITY_NAME, 
                SEDOL_NO, 
                SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
            FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
            WHERE FUND_MANAGER_CODE = 429
            AND FUND_REF = 37771
            GROUP BY SECURITY_NAME, SEDOL_NO
            ORDER BY SECURITY_VALUE DESC
        ) AS SECURITY_TABLE
    WHERE SECTOR_TABLE.SEDOL_NO = SECURITY_TABLE.SEDOL_NO
    AND SECTOR_TABLE.ASSET_CLASS_SUBSECTOR_COMBO_INTERNAL = SECTOR_MAPPING.ICB_SUB_SECTOR
    --AND SECTOR_TABLE.EQUITY_ONLY = 'Yes'
    ) AS SECTOR_FINAL_RES

/* #9: Industry Value for a selected Fund Manager and a selected Fund group by Industry - ALL SECURITIES or EQUITY ONLY*/
SELECT INDUSTRY_FINAL_RES.ICB_INDUSTRY AS ICB_INDUSTRY,
       SUM(INDUSTRY_FINAL_RES.FINAL_VALUE) AS INDUSTRY_VALUE
FROM
    (SELECT SECTOR_TABLE.SEDOL_NO AS SEDOL_NO,
            SECTOR_TABLE.VENDOR AS VENDOR,
            SECTOR_TABLE.NET_WEIGHT_DECIMAL AS NET_WEIGHT_DECIMAL,
            SECURITY_TABLE.SECURITY_VALUE AS SECURITY_VALUE,
            SECTOR_MAPPING.ICB_INDUSTRY AS ICB_INDUSTRY,
            SECURITY_TABLE.SECURITY_VALUE * SECTOR_TABLE.NET_WEIGHT_DECIMAL AS FINAL_VALUE
    FROM DEV_ANALYTICS_DB.CIO_VISION.FULL_UNIVERSE_SECTOR AS SECTOR_TABLE,
         DEV_ANALYTICS_DB.CIO_VISION.SECTOR_MAPPING AS SECTOR_MAPPING,
        (SELECT SECURITY_NAME, 
                SEDOL_NO, 
                SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
            FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
            WHERE FUND_MANAGER_CODE = 429
            --AND FUND_REF = 37771
            GROUP BY SECURITY_NAME, SEDOL_NO
            ORDER BY SECURITY_VALUE DESC
        ) AS SECURITY_TABLE
    WHERE SECTOR_TABLE.SEDOL_NO = SECURITY_TABLE.SEDOL_NO
    AND SECTOR_TABLE.ASSET_CLASS_SUBSECTOR_COMBO_INTERNAL = SECTOR_MAPPING.ICB_SUB_SECTOR
    AND SECTOR_TABLE.EQUITY_ONLY = 'Yes'
    ) AS INDUSTRY_FINAL_RES
GROUP BY ICB_INDUSTRY
ORDER BY INDUSTRY_VALUE DESC

/* #10: Sector Value for a selected Fund Manager and a selected Fund group by Sector - ALL SECURITIES or EQUITY ONLY*/
SELECT SECTOR_FINAL_RES.ICB_SECTOR AS ICB_SECTOR,
       SUM(SECTOR_FINAL_RES.FINAL_VALUE) AS SECTOR_VALUE
FROM
    (SELECT SECTOR_TABLE.SEDOL_NO AS SEDOL_NO,
            SECTOR_TABLE.VENDOR AS VENDOR,
            SECTOR_TABLE.NET_WEIGHT_DECIMAL AS NET_WEIGHT_DECIMAL,
            SECURITY_TABLE.SECURITY_VALUE AS SECURITY_VALUE,
            SECTOR_MAPPING.ICB_SECTOR AS ICB_SECTOR,
            SECURITY_TABLE.SECURITY_VALUE * SECTOR_TABLE.NET_WEIGHT_DECIMAL AS FINAL_VALUE
    FROM DEV_ANALYTICS_DB.CIO_VISION.FULL_UNIVERSE_SECTOR AS SECTOR_TABLE,
         DEV_ANALYTICS_DB.CIO_VISION.SECTOR_MAPPING AS SECTOR_MAPPING,
        (SELECT SECURITY_NAME, 
                SEDOL_NO, 
                SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
            FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
            WHERE FUND_MANAGER_CODE = 429
            AND FUND_REF = 37771
            GROUP BY SECURITY_NAME, SEDOL_NO
            ORDER BY SECURITY_VALUE DESC
        ) AS SECURITY_TABLE
    WHERE SECTOR_TABLE.SEDOL_NO = SECURITY_TABLE.SEDOL_NO
    AND SECTOR_TABLE.ASSET_CLASS_SUBSECTOR_COMBO_INTERNAL = SECTOR_MAPPING.ICB_SUB_SECTOR
    --AND SECTOR_TABLE.EQUITY_ONLY = 'Yes'
    ) AS SECTOR_FINAL_RES
GROUP BY ICB_SECTOR
ORDER BY SECTOR_VALUE DESC

/* =========================================== TEST on LED and Asset Class Page ==================================== */
/* (**NOTE: LED Alteryx transformation has been modified again in June 2024, therefore some of the field names are no longer the same)*/

/* #1: LED Total Value for a selected Fund Manager  */
SELECT SUM(FINAL_VALUE)
FROM
    (SELECT LED_TABLE.SEDOL_NO,
            LED_TABLE.ASSET_CLASS,
            --LED_TABLE.VENDOR,
            LED_TABLE.NET_WEIGHT_DECIMAL,
            LED_TABLE.LED_CODE,
            SECURITY_TABLE.VALUE,
            SECURITY_TABLE.VALUE * LED_TABLE.NET_WEIGHT_DECIMAL AS FINAL_VALUE
        FROM DEV_ANALYTICS_DB.CIO_VISION.LED AS LED_TABLE,
            (SELECT SECURITY_NAME, 
                    SEDOL_NO, 
                    SUM(SUM_TOTAL_VALUE) AS VALUE
                FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
                WHERE FUND_MANAGER_CODE = 429
                GROUP BY SECURITY_NAME, SEDOL_NO
                ORDER BY VALUE DESC
            ) AS SECURITY_TABLE
    WHERE LED_TABLE.SEDOL_NO = SECURITY_TABLE.SEDOL_NO
    )

/* #2: LED Total Value for a selected Fund Manager and a selected Fund (e.g. fund_ref: 37771) */
SELECT SUM(FINAL_VALUE)
FROM
    (SELECT LED_TABLE.SEDOL_NO,
            LED_TABLE.ASSET_CLASS,
            --LED_TABLE.VENDOR,
            LED_TABLE.NET_WEIGHT_DECIMAL,
            LED_TABLE.LED_CODE,
            SECURITY_TABLE.VALUE,
            SECURITY_TABLE.VALUE * LED_TABLE.NET_WEIGHT_DECIMAL AS FINAL_VALUE
    FROM DEV_ANALYTICS_DB.CIO_VISION.LED AS LED_TABLE,
        (SELECT SECURITY_NAME, 
                SEDOL_NO, 
                SUM(SUM_TOTAL_VALUE) AS VALUE
            FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
            WHERE FUND_MANAGER_CODE = 429
            AND FUND_REF = 37771
            GROUP BY SECURITY_NAME, SEDOL_NO
            ORDER BY VALUE DESC
        ) AS SECURITY_TABLE
    WHERE LED_TABLE.SEDOL_NO = SECURITY_TABLE.SEDOL_NO
    )

/* #3: LED Breakdown Value for a selected Fund Manager and a selected Fund (e.g. fund ref: 37771) group by LED Code */
SELECT LED_RES.LED_CODE,
       SUM(LED_RES.FINAL_VALUE)
FROM
    (SELECT LED_TABLE.SEDOL_NO AS SEDOL_NO,
            LED_TABLE.ASSET_CLASS AS ASSET_CLASS_REGION_COMBO_INTERNAL,
            --LED_TABLE.VENDOR AS VENDOR,
            LED_TABLE.NET_WEIGHT_DECIMAL AS NET_WEIGHT_DECIMAL,
            LED_TABLE.LED_CODE AS LED_CODE,
            SECURITY_TABLE.VALUE AS VALUE,
            SECURITY_TABLE.VALUE * LED_TABLE.NET_WEIGHT_DECIMAL AS FINAL_VALUE
    FROM DEV_ANALYTICS_DB.CIO_VISION.LED AS LED_TABLE,
        (SELECT SECURITY_NAME, 
                SEDOL_NO, 
                SUM(SUM_TOTAL_VALUE) AS VALUE
            FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
            WHERE FUND_MANAGER_CODE = 429
            AND FUND_REF = 37771
            GROUP BY SECURITY_NAME, SEDOL_NO
            ORDER BY VALUE DESC
        ) AS SECURITY_TABLE
    WHERE LED_TABLE.SEDOL_NO = SECURITY_TABLE.SEDOL_NO
    ) AS LED_RES
GROUP BY LED_RES.LED_CODE
ORDER BY LED_RES.LED_CODE

/* #4: LED Breakdown Value for a selected Fund Manager group by LED Code */
SELECT LED_RES.LED_CODE,
       SUM(LED_RES.FINAL_VALUE)
FROM
    (SELECT LED_TABLE.SEDOL_NO AS SEDOL_NO,
            LED_TABLE.ASSET_CLASS AS ASSET_CLASS_REGION_COMBO_INTERNAL,
            --LED_TABLE.VENDOR AS VENDOR,
            LED_TABLE.NET_WEIGHT_DECIMAL AS NET_WEIGHT_DECIMAL,
            LED_TABLE.LED_CODE AS LED_CODE,
            SECURITY_TABLE.VALUE AS VALUE,
            SECURITY_TABLE.VALUE * LED_TABLE.NET_WEIGHT_DECIMAL AS FINAL_VALUE
    FROM DEV_ANALYTICS_DB.CIO_VISION.LED AS LED_TABLE,
        (SELECT SECURITY_NAME, 
                SEDOL_NO, 
                SUM(SUM_TOTAL_VALUE
        ) AS VALUE
            FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
            WHERE FUND_MANAGER_CODE = 429
            GROUP BY SECURITY_NAME, SEDOL_NO
            ORDER BY VALUE DESC) AS SECURITY_TABLE
    WHERE LED_TABLE.SEDOL_NO = SECURITY_TABLE.SEDOL_NO
    ) AS LED_RES
GROUP BY LED_RES.LED_CODE
ORDER BY LED_RES.LED_CODE

/* #5: LED Breakdown Value for a selected Fund Manager group by LED Code, Asset Class 
(**NOTE: LED Alteryx transformation has been modified again in June 2024, therefore some of the field names are no longer the same)*/
SELECT LED_RES.LED_CODE,
       LED_RES.ASSET_CLASS,
       SUM(LED_RES.FINAL_VALUE)
FROM
    (SELECT LED_TABLE.SEDOL_NO AS SEDOL_NO,
            LED_TABLE.ASSET_CLASS AS ASSET_CLASS_REGION_COMBO_INTERNAL,
            --LED_TABLE.VENDOR AS VENDOR,
            LED_TABLE.NET_WEIGHT_DECIMAL AS NET_WEIGHT_DECIMAL,
            LED_TABLE.LED_CODE AS LED_CODE,
            LED_TABLE.ASSET_CLASS AS ASSET_CLASS,
            SECURITY_TABLE.VALUE AS VALUE,
            SECURITY_TABLE.VALUE * LED_TABLE.NET_WEIGHT_DECIMAL AS FINAL_VALUE
    FROM DEV_ANALYTICS_DB.CIO_VISION.LED AS LED_TABLE,
        (SELECT SECURITY_NAME, 
                SEDOL_NO, 
                SUM(SUM_TOTAL_VALUE) AS VALUE
            FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
            WHERE FUND_MANAGER_CODE = 429
            GROUP BY SECURITY_NAME, SEDOL_NO
            ORDER BY VALUE DESC
        ) AS SECURITY_TABLE
    WHERE LED_TABLE.SEDOL_NO = SECURITY_TABLE.SEDOL_NO
    ) AS LED_RES
GROUP BY LED_RES.LED_CODE,LED_RES.ASSET_CLASS
ORDER BY LED_RES.LED_CODE,LED_RES.ASSET_CLASS

/* #6: LED Breakdown Value for a selected Fund Manager and a selected Fund group by LED Code, Asset Class 
(**NOTE: LED Alteryx transformation has been modified again in June 2024, therefore some of the field names are no longer the same)*/
SELECT LED_RES.LED_CODE,
       LED_RES.ASSET_CLASS,
       SUM(LED_RES.FINAL_VALUE)
FROM
    (SELECT LED_TABLE.SEDOL_NO AS SEDOL_NO,
            LED_TABLE.ASSET_CLASS AS ASSET_CLASS_REGION_COMBO_INTERNAL,
            --LED_TABLE.VENDOR AS VENDOR,
            LED_TABLE.NET_WEIGHT_DECIMAL AS NET_WEIGHT_DECIMAL,
            LED_TABLE.LED_CODE AS LED_CODE,
            LED_TABLE.ASSET_CLASS AS ASSET_CLASS,
            SECURITY_TABLE.VALUE AS VALUE,
            SECURITY_TABLE.VALUE * LED_TABLE.NET_WEIGHT_DECIMAL AS FINAL_VALUE
     FROM DEV_ANALYTICS_DB.CIO_VISION.LED AS LED_TABLE,
         (SELECT SECURITY_NAME, 
                 SEDOL_NO, 
                 SUM(SUM_TOTAL_VALUE) AS VALUE
            FROM  DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
            WHERE FUND_MANAGER_CODE = 429
            AND FUND_REF = 37771
            GROUP BY SECURITY_NAME, SEDOL_NO
            ORDER BY VALUE DESC
          ) AS SECURITY_TABLE
     WHERE LED_TABLE.SEDOL_NO = SECURITY_TABLE.SEDOL_NO
     ) AS LED_RES
GROUP BY LED_RES.LED_CODE,LED_RES.ASSET_CLASS
ORDER BY LED_RES.LED_CODE,LED_RES.ASSET_CLASS

/* ===================================== TEST on Style Analytics Page =============================================== */

/* #1: Tilt Value of selected Security Name (e.g. SHELL PLC) within a selected Fund (e.g. fund_ref: 37771) using Rathbones Benchmark 1 */
SELECT SECURITY_TABLE.SECURITY_NAME,
       SECURITY_TABLE.SECURITY_VALUE,
       TILT_TABLE.VALUE_TILT AS VALUE,
       TILT_TABLE.YIELD_TILT AS YIELD,
       TILT_TABLE.GROWTH_TILT AS GROWTH,
       TILT_TABLE.QUALITY_TILT AS QUALITY,
       TILT_TABLE.MARKET_CAP_TILT AS SIZE,
       TILT_TABLE.VOLATILITY_TILT AS VOLATILITY,
       TILT_TABLE.MOMENTUM_TILT AS MOMENTUM
FROM DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_TILT_RB1 AS TILT_TABLE,
    (SELECT SEDOL_NO AS SEDOL_NO,
            SECURITY_NAME AS SECURITY_NAME,
            SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
        FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
        WHERE FUND_MANAGER_CODE = 429
        AND SEDOL_NO = 'BP6MXD8'
        AND FUND_REF = 37771
        GROUP BY SECURITY_NAME, SEDOL_NO
        ORDER BY SECURITY_VALUE DESC
     ) AS SECURITY_TABLE
WHERE SECURITY_TABLE.SEDOL_NO = TILT_TABLE.SEDOL_NO
ORDER BY SECURITY_NAME

/* #2: Tilt Value of selected Security Name (e.g. AMAZON COM INC) for a selected Fund Manager using Rathbones Benchmark 5 */
SELECT SECURITY_TABLE.SECURITY_NAME,
       SECURITY_TABLE.SECURITY_VALUE,
       TILT_TABLE.VALUE_TILT AS VALUE,
       TILT_TABLE.YIELD_TILT AS YIELD,
       TILT_TABLE.GROWTH_TILT AS GROWTH,
       TILT_TABLE.QUALITY_TILT AS QUALITY,
       TILT_TABLE.MARKET_CAP_TILT AS SIZE,
       TILT_TABLE.VOLATILITY_TILT AS VOLATILITY,
       TILT_TABLE.MOMENTUM_TILT AS MOMENTUM
FROM DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_TILT_RB5 AS TILT_TABLE,
    (SELECT SEDOL_NO AS SEDOL_NO,
            SECURITY_NAME AS SECURITY_NAME,
            SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
        FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS
        WHERE FUND_MANAGER_CODE = 429
        AND SEDOL_NO = '2000019'
        GROUP BY SECURITY_NAME, SEDOL_NO
        ORDER BY SECURITY_VALUE DESC
     ) AS SECURITY_TABLE
WHERE SECURITY_TABLE.SEDOL_NO = TILT_TABLE.SEDOL_NO
ORDER BY SECURITY_NAME

/* #3: Factor Value of selected Security Name (e.g. AMAZON COM INC) for a selected Fund Manager (e.g. fund_manager 429) */ 
SELECT BOOK_TO_PRICE_FACTOR,        --Value Factor
       SALES_GROWTH_FACTOR,         --Growth Factor
       DIVIDEND_YIELD_FACTOR,       --Yield Factor
       RETURN_ON_EQUITY_FACTOR,     --Quality Factor
       ROIC_FACTOR,                 --Quality Factor
       MARKET_BETA_FACTOR,          --Volatility Factor
       MOMENTUM_ST_FACTOR,          --Momentum Factor
FROM DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_FACTOR
WHERE SEDOL_NO = '2000019'

/* #4: Portfolio weighted avergage Rathbones BENCHMARK data using RB Benchmark 1 */ 
SELECT * FROM DEV_ANALYTICS_DB.CIO_VISION.STYLE_BENCHMARK_WEIGHTED_AVERAGE_FACTOR_RB1 

/* #5: Portfolio weighted avergage FACTOR data for a selected Fund Manager (e.g. fund_manager 429) */ 
SELECT SUM(WA_BOOK_TO_PRICE) AS PORTFOLIO_WA_BOOK_TO_PRICE,
       SUM(WA_DIVIDEND_YIELD) AS PORTFOLIO_WA_DIVIDEND_YIELD,
       SUM(WA_RETURN_ON_EQUITY) AS PORTFOLIO_WA_RETURN_ON_EQUITY
FROM
    (SELECT WEIGHT_AVG_TABLE.SEDOL_NO,
            WEIGHT_AVG_TABLE.PORTFOLIO_WA * BOOK_TO_PRICE_FACTOR AS WA_BOOK_TO_PRICE,
            WEIGHT_AVG_TABLE.PORTFOLIO_WA * DIVIDEND_YIELD_FACTOR AS WA_DIVIDEND_YIELD,
            WEIGHT_AVG_TABLE.PORTFOLIO_WA * RETURN_ON_EQUITY_FACTOR AS WA_RETURN_ON_EQUITY      
    FROM
        (SELECT VALUE_TABLE.SEDOL_NO AS SEDOL_NO,
                VALUE_TABLE.SECURITY_VALUE / TOTAL_VALUE_SECURITIES.TOTAL_VALUE AS PORTFOLIO_WA
            FROM
                (SELECT SECURITY_TABLE.SEDOL_NO AS SEDOL_NO,
                        SECURITY_TABLE.SUM_TOTAL_VALUE AS SECURITY_VALUE
                        FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS AS SECURITY_TABLE,
                             DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_FACTOR AS FACTOR_TABLE
                        WHERE SECURITY_TABLE.SEDOL_NO = FACTOR_TABLE.SEDOL_NO
                        AND SECURITY_TABLE.FUND_MANAGER_CODE = 429
                        AND FACTOR_TABLE.HAS_STYLE_DATA_VALUE = 'Yes' -- value of individual security that has style data
                ) AS VALUE_TABLE,
                (SELECT SUM(SECURITY_TABLE.SUM_TOTAL_VALUE) AS TOTAL_VALUE
                    FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS AS SECURITY_TABLE,
                         DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_FACTOR AS FACTOR_TABLE
                    WHERE SECURITY_TABLE.SEDOL_NO = FACTOR_TABLE.SEDOL_NO
                    AND SECURITY_TABLE.FUND_MANAGER_CODE = 429
                    AND FACTOR_TABLE.HAS_STYLE_DATA_VALUE = 'Yes'
                ) AS TOTAL_VALUE_SECURITIES -- total value of all securities that has style data
         ) AS WEIGHT_AVG_TABLE,   -- weight average of individual security within the portfolio 
          DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_FACTOR AS PORTFOLIO_FACTOR_TABLE
    WHERE PORTFOLIO_FACTOR_TABLE.SEDOL_NO = WEIGHT_AVG_TABLE.SEDOL_NO
    )

/* #6: Portfolio weighted avergage TILT data for a selected Fund Manager (e.g. fund_manager 429) using Rathbones Benchmark 4 */ 
SELECT SUM(WA_BOOK_TO_PRICE_TILT) AS PORTFOLIO_WA_BOOK_TO_PRICE,
       SUM(WA_DIVIDEND_YIELD_TILT) AS PORTFOLIO_WA_DIVIDEND_YIELD,
       SUM(WA_RETURN_ON_EQUITY_TILT) AS PORTFOLIO_WA_RETURN_ON_EQUITY
FROM
    (SELECT WEIGHT_AVG_TABLE.SEDOL_NO,
            WEIGHT_AVG_TABLE.PORTFOLIO_WA * BOOK_TO_PRICE_TILT AS WA_BOOK_TO_PRICE_TILT,
            WEIGHT_AVG_TABLE.PORTFOLIO_WA * DIVIDEND_YIELD_TILT AS WA_DIVIDEND_YIELD_TILT,
            WEIGHT_AVG_TABLE.PORTFOLIO_WA * RETURN_ON_EQUITY_TILT AS WA_RETURN_ON_EQUITY_TILT      
    FROM
        (SELECT VALUE_TABLE.SEDOL_NO AS SEDOL_NO,
                VALUE_TABLE.SECURITY_VALUE / TOTAL_VALUE_SECURITIES.TOTAL_VALUE AS PORTFOLIO_WA
            FROM
                (SELECT SECURITY_TABLE.SEDOL_NO AS SEDOL_NO,
                        SECURITY_TABLE.SUM_TOTAL_VALUE AS SECURITY_VALUE
                        FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS AS SECURITY_TABLE,
                             DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_FACTOR AS FACTOR_TABLE
                        WHERE SECURITY_TABLE.SEDOL_NO = FACTOR_TABLE.SEDOL_NO
                        AND SECURITY_TABLE.FUND_MANAGER_CODE = 429
                        AND FACTOR_TABLE.HAS_STYLE_DATA_VALUE = 'Yes'
                ) AS VALUE_TABLE,
                (SELECT SUM(SECURITY_TABLE.SUM_TOTAL_VALUE) AS TOTAL_VALUE
                    FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS AS SECURITY_TABLE,
                         DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_FACTOR AS FACTOR_TABLE
                    WHERE SECURITY_TABLE.SEDOL_NO = FACTOR_TABLE.SEDOL_NO
                    AND SECURITY_TABLE.FUND_MANAGER_CODE = 429
                    AND FACTOR_TABLE.HAS_STYLE_DATA_VALUE = 'Yes'
                ) AS TOTAL_VALUE_SECURITIES 
         ) AS WEIGHT_AVG_TABLE,
          DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_TILT_RB4 AS TILT_TABLE
    WHERE TILT_TABLE.SEDOL_NO = WEIGHT_AVG_TABLE.SEDOL_NO
    )
    
/* #7: Portfolio weighted avergage FACTOR data of a selected Fund Manager (e.g. fund_manager 429) and a selected Fund (e.g. fund_ref: 37771) */ 
SELECT SUM(WA_EARNINGS_GROWTH) AS PORTFOLIO_WA_EARNINGS_GROWTH,
       SUM(WA_ROIC) AS PORTFOLIO_WA_ROIC,
       SUM(WA_MARKET_BETA) AS PORTFOLIO_WA_MARKET_BETA
FROM
    (SELECT WEIGHT_AVG_TABLE.SEDOL_NO,
            WEIGHT_AVG_TABLE.PORTFOLIO_WA * EARNINGS_GROWTH_FACTOR AS WA_EARNINGS_GROWTH,
            WEIGHT_AVG_TABLE.PORTFOLIO_WA * ROIC_FACTOR AS WA_ROIC,
            WEIGHT_AVG_TABLE.PORTFOLIO_WA * MARKET_BETA_FACTOR AS WA_MARKET_BETA     
    FROM
        (SELECT VALUE_TABLE.SEDOL_NO AS SEDOL_NO,
                VALUE_TABLE.SECURITY_VALUE / TOTAL_VALUE_SECURITIES.TOTAL_VALUE AS PORTFOLIO_WA
            FROM
                (SELECT SECURITY_TABLE.SEDOL_NO AS SEDOL_NO,
                        SECURITY_TABLE.SUM_TOTAL_VALUE AS SECURITY_VALUE
                        FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS AS SECURITY_TABLE,
                             DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_FACTOR AS FACTOR_TABLE
                        WHERE SECURITY_TABLE.SEDOL_NO = FACTOR_TABLE.SEDOL_NO
                        AND SECURITY_TABLE.FUND_MANAGER_CODE = 429
                        AND SECURITY_TABLE.FUND_REF = 37771
                        AND FACTOR_TABLE.HAS_STYLE_DATA_VALUE = 'Yes'
                ) AS VALUE_TABLE,
                (SELECT SUM(SECURITY_TABLE.SUM_TOTAL_VALUE) AS TOTAL_VALUE
                    FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS AS SECURITY_TABLE,
                         DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_FACTOR AS FACTOR_TABLE
                    WHERE SECURITY_TABLE.SEDOL_NO = FACTOR_TABLE.SEDOL_NO
                    AND SECURITY_TABLE.FUND_MANAGER_CODE = 429
                    AND SECURITY_TABLE.FUND_REF = 37771
                    AND FACTOR_TABLE.HAS_STYLE_DATA_VALUE = 'Yes'
                ) AS TOTAL_VALUE_SECURITIES
         ) AS WEIGHT_AVG_TABLE,    
          DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_FACTOR AS PORTFOLIO_FACTOR_TABLE
    WHERE PORTFOLIO_FACTOR_TABLE.SEDOL_NO = WEIGHT_AVG_TABLE.SEDOL_NO
    )

/* #8: Portfolio weighted average VALUE TILT for a selected Fund Manager and a selected Security Name (e.g. BP PLC) using RB Benchmark 4 Tilt Data */ 
SELECT TILT_TABLE.SEDOL_NO,
       WEIGHT_AVG_TABLE.WA_SECURITY_VALUE * TILT_TABLE.VALUE_TILT AS WA_SECURITY_TILT  
FROM
    (SELECT VALUE_TABLE.SEDOL_NO AS SEDOL_NO,
            VALUE_TABLE.SECURITY_VALUE / TOTAL_VALUE_TABLE.TOTAL_VALUE AS WA_SECURITY_VALUE
        FROM
            (SELECT SEDOL_NO,
                    SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
                FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS    
                WHERE FUND_MANAGER_CODE = 429
                AND SEDOL_NO = '0798059'
                GROUP BY SEDOL_NO
            ) AS VALUE_TABLE,
            (SELECT SUM(HOLDING_TABLE.SUM_TOTAL_VALUE) AS TOTAL_VALUE
                FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS AS HOLDING_TABLE,
                     DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_FACTOR AS FACTOR_TABLE
                WHERE HOLDING_TABLE.SEDOL_NO = FACTOR_TABLE.SEDOL_NO
                AND HOLDING_TABLE.FUND_MANAGER_CODE = 429
                AND FACTOR_TABLE.HAS_STYLE_DATA_VALUE = 'Yes'
            ) AS TOTAL_VALUE_TABLE
    ) AS WEIGHT_AVG_TABLE,
    DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_TILT_RB4 AS TILT_TABLE
WHERE TILT_TABLE.SEDOL_NO = WEIGHT_AVG_TABLE.SEDOL_NO

/* #9: Portfolio weighted average BOOK TO PRICE TILT for a selected Fund Manager and a selected Security Name (e.g. ASTRAZENECA PLC) using RB Benchmark 4 Tilt Data */ 
SELECT TILT_TABLE.SEDOL_NO,
       WEIGHT_AVG_TABLE.WA_SECURITY_VALUE * TILT_TABLE.BOOK_TO_PRICE_TILT AS WA_SECURITY_TILT  
FROM
    (SELECT VALUE_TABLE.SEDOL_NO AS SEDOL_NO,
            VALUE_TABLE.SECURITY_VALUE / TOTAL_VALUE_TABLE.TOTAL_VALUE AS WA_SECURITY_VALUE
        FROM
            (SELECT SEDOL_NO,
                    SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
                FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS    
                WHERE FUND_MANAGER_CODE = 429
                AND SEDOL_NO = '0989529'
                GROUP BY SEDOL_NO
            ) AS VALUE_TABLE,
            (SELECT SUM(HOLDING_TABLE.SUM_TOTAL_VALUE) AS TOTAL_VALUE
                FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS AS HOLDING_TABLE,
                     DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_FACTOR AS FACTOR_TABLE
                WHERE HOLDING_TABLE.SEDOL_NO = FACTOR_TABLE.SEDOL_NO
                AND HOLDING_TABLE.FUND_MANAGER_CODE = 429
                AND FACTOR_TABLE.HAS_STYLE_DATA_VALUE_BOOKTOPRICE = 'Yes'
            ) AS TOTAL_VALUE_TABLE
    ) AS WEIGHT_AVG_TABLE,
    DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_TILT_RB4 AS TILT_TABLE
WHERE TILT_TABLE.SEDOL_NO = WEIGHT_AVG_TABLE.SEDOL_NO

/* #10: Portfolio weighted average EARNINGS GROWTH TILT for a selected Fund Manager and a selected Security Name (e.g. VISA INC) using RB Benchmark 4 Tilt Data */ 
SELECT TILT_TABLE.SEDOL_NO,
       WEIGHT_AVG_TABLE.WA_SECURITY_VALUE * TILT_TABLE.EARNINGS_GROWTH_TILT AS WA_SECURITY_TILT  
FROM
    (SELECT VALUE_TABLE.SEDOL_NO AS SEDOL_NO,
            VALUE_TABLE.SECURITY_VALUE / TOTAL_VALUE_TABLE.TOTAL_VALUE AS WA_SECURITY_VALUE
        FROM
            (SELECT SEDOL_NO,
                    SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
                FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS    
                WHERE FUND_MANAGER_CODE = 429
                AND SEDOL_NO = 'B2PZN04'
                GROUP BY SEDOL_NO
            ) AS VALUE_TABLE,
            (SELECT SUM(HOLDING_TABLE.SUM_TOTAL_VALUE) AS TOTAL_VALUE
                FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS AS HOLDING_TABLE,
                     DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_FACTOR AS FACTOR_TABLE
                WHERE HOLDING_TABLE.SEDOL_NO = FACTOR_TABLE.SEDOL_NO
                AND HOLDING_TABLE.FUND_MANAGER_CODE = 429
                AND FACTOR_TABLE.HAS_STYLE_DATA_GROWTH_EARNINGSGROWTH = 'Yes'
            ) AS TOTAL_VALUE_TABLE
    ) AS WEIGHT_AVG_TABLE,
    DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_TILT_RB4 AS TILT_TABLE
WHERE TILT_TABLE.SEDOL_NO = WEIGHT_AVG_TABLE.SEDOL_NO

/* #11: Portfolio weighted average DIVIDEND YIELD TILT for a selected Fund Manager and a selected Security Name (e.g. ALPHABET INC) using RB Benchmark 4 Tilt Data */ 
SELECT TILT_TABLE.SEDOL_NO,
       WEIGHT_AVG_TABLE.WA_SECURITY_VALUE * TILT_TABLE.DIVIDEND_YIELD_TILT AS WA_SECURITY_TILT  
FROM
    (SELECT VALUE_TABLE.SEDOL_NO AS SEDOL_NO,
            VALUE_TABLE.SECURITY_VALUE / TOTAL_VALUE_TABLE.TOTAL_VALUE AS WA_SECURITY_VALUE
        FROM
            (SELECT SEDOL_NO,
                    SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
                FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS    
                WHERE FUND_MANAGER_CODE = 429
                AND SEDOL_NO = 'BYVY8G0'
                GROUP BY SEDOL_NO
            ) AS VALUE_TABLE,
            (SELECT SUM(HOLDING_TABLE.SUM_TOTAL_VALUE) AS TOTAL_VALUE
                FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS AS HOLDING_TABLE,
                     DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_FACTOR AS FACTOR_TABLE
                WHERE HOLDING_TABLE.SEDOL_NO = FACTOR_TABLE.SEDOL_NO
                AND HOLDING_TABLE.FUND_MANAGER_CODE = 429
                AND FACTOR_TABLE.HAS_STYLE_DATA_YIELD_DIVIDENDYIELD = 'Yes'
            ) AS TOTAL_VALUE_TABLE
    ) AS WEIGHT_AVG_TABLE,
    DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_TILT_RB4 AS TILT_TABLE
WHERE TILT_TABLE.SEDOL_NO = WEIGHT_AVG_TABLE.SEDOL_NO

/* #12: Portfolio weighted average OPERATING PROFIT MARGIN TILT for a selected Fund Manager and a selected Security Name (e.g. MICROSOFT CORP) using RB Benchmark 4 Tilt Data */ 
SELECT TILT_TABLE.SEDOL_NO,
       WEIGHT_AVG_TABLE.WA_SECURITY_VALUE * TILT_TABLE.OPERATING_PROFIT_MARGIN_TILT AS WA_SECURITY_TILT  
FROM
    (SELECT VALUE_TABLE.SEDOL_NO AS SEDOL_NO,
            VALUE_TABLE.SECURITY_VALUE / TOTAL_VALUE_TABLE.TOTAL_VALUE AS WA_SECURITY_VALUE
        FROM
            (SELECT SEDOL_NO,
                    SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
                FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS    
                WHERE FUND_MANAGER_CODE = 429
                AND SEDOL_NO = '2588173'
                GROUP BY SEDOL_NO
            ) AS VALUE_TABLE,
            (SELECT SUM(HOLDING_TABLE.SUM_TOTAL_VALUE) AS TOTAL_VALUE
                FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS AS HOLDING_TABLE,
                     DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_FACTOR AS FACTOR_TABLE
                WHERE HOLDING_TABLE.SEDOL_NO = FACTOR_TABLE.SEDOL_NO
                AND HOLDING_TABLE.FUND_MANAGER_CODE = 429
                AND FACTOR_TABLE.HAS_STYLE_DATA_QUALITY_OPERATINGPROFITMARGIN = 'Yes'
            ) AS TOTAL_VALUE_TABLE
    ) AS WEIGHT_AVG_TABLE,
    DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_TILT_RB4 AS TILT_TABLE
WHERE TILT_TABLE.SEDOL_NO = WEIGHT_AVG_TABLE.SEDOL_NO

/* #13: Portfolio weighted average VOLATILITY TILT for a selected Fund Manager and a selected Security Name (e.g. COCA-COLA CO) using RB Benchmark 4 Tilt Data */ 
SELECT TILT_TABLE.SEDOL_NO,
       WEIGHT_AVG_TABLE.WA_SECURITY_VALUE * TILT_TABLE.VOLATILITY_TILT AS WA_SECURITY_TILT  
FROM
    (SELECT VALUE_TABLE.SEDOL_NO AS SEDOL_NO,
            VALUE_TABLE.SECURITY_VALUE / TOTAL_VALUE_TABLE.TOTAL_VALUE AS WA_SECURITY_VALUE
        FROM
            (SELECT SEDOL_NO,
                    SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
                FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS    
                WHERE FUND_MANAGER_CODE = 429
                AND SEDOL_NO = '2206657'
                GROUP BY SEDOL_NO
            ) AS VALUE_TABLE,
            (SELECT SUM(HOLDING_TABLE.SUM_TOTAL_VALUE) AS TOTAL_VALUE
                FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS AS HOLDING_TABLE,
                     DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_FACTOR AS FACTOR_TABLE
                WHERE HOLDING_TABLE.SEDOL_NO = FACTOR_TABLE.SEDOL_NO
                AND HOLDING_TABLE.FUND_MANAGER_CODE = 429
                AND FACTOR_TABLE.HAS_STYLE_DATA_VOLATILITY = 'Yes'
            ) AS TOTAL_VALUE_TABLE
    ) AS WEIGHT_AVG_TABLE,
    DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_TILT_RB4 AS TILT_TABLE
WHERE TILT_TABLE.SEDOL_NO = WEIGHT_AVG_TABLE.SEDOL_NO

/* #14: Portfolio weighted average MOMENTUM ST TILT for a selected Fund Manager and a selected Security Name (e.g. FUTURE PLC) using RB Benchmark 4 Tilt Data */ 
SELECT TILT_TABLE.SEDOL_NO,
       WEIGHT_AVG_TABLE.WA_SECURITY_VALUE * TILT_TABLE.MOMENTUM_ST_TILT AS WA_SECURITY_TILT  
FROM
    (SELECT VALUE_TABLE.SEDOL_NO AS SEDOL_NO,
            VALUE_TABLE.SECURITY_VALUE / TOTAL_VALUE_TABLE.TOTAL_VALUE AS WA_SECURITY_VALUE
        FROM
            (SELECT SEDOL_NO,
                    SUM(SUM_TOTAL_VALUE) AS SECURITY_VALUE
                FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS    
                WHERE FUND_MANAGER_CODE = 429
                AND SEDOL_NO = 'BYZN904'
                GROUP BY SEDOL_NO
            ) AS VALUE_TABLE,
            (SELECT SUM(HOLDING_TABLE.SUM_TOTAL_VALUE) AS TOTAL_VALUE
                FROM DEV_ANALYTICS_DB.CIO_VISION.HOLDINGS AS HOLDING_TABLE,
                     DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_FACTOR AS FACTOR_TABLE
                WHERE HOLDING_TABLE.SEDOL_NO = FACTOR_TABLE.SEDOL_NO
                AND HOLDING_TABLE.FUND_MANAGER_CODE = 429
                AND FACTOR_TABLE.HAS_STYLE_DATA_MOMENTUM_ST = 'Yes'
            ) AS TOTAL_VALUE_TABLE
    ) AS WEIGHT_AVG_TABLE,
    DEV_ANALYTICS_DB.CIO_VISION.STYLE_EQUITY_TILT_RB4 AS TILT_TABLE
WHERE TILT_TABLE.SEDOL_NO = WEIGHT_AVG_TABLE.SEDOL_NO

